<div header class="view-container__header"></div>

<div class="view-container__content">

    <!--Trial period countdown-->
    <div ng-if="currentUser.showTrialRemainingDays()">
        <div ng-include src="'/app/account/partials/trial_period_countdown.html'"></div>
    </div>

    <!--Account confirmation alert-->
    <div ng-if="! currentUser.model.emailConfirmed">
        <div ng-include src="'/app/account/partials/email_confirmation_resend_template.html'"></div>
    </div>

    <!-- Flash messages. -->
    <div flash-messages flash="flash" identifier-id="{{alertIdentifierId}}"></div>

    <!--Empty state if no expenses overall-->
    <div class="insights__empty-state" ng-if="insight.model.totalNumberOfTransactions === 0">
        <div class="insights__empty-state__icon"></div>
        <h1>No data yet.</h1>

        <div>Add some expenses to get insights.</div>
    </div>

    <div ng-show="insight.model.totalNumberOfTransactions !== 0">
        <!-- Insight fetch form -->
        <div class="insights__controls">

            <form name="insightForm" class="insights__controls__form" ng-submit="submitLoadInsight()" novalidate>

                <!-- Select prev month -->
                <button type="button" class="insights__controls__form__arrow icon-chevron-left" ng-disabled="isLoading || ! canLoadPrevMonth()" ng-click="prevMonth()"></button>

                <div class="insights__controls__form__month" ng-class="{'has-error': insightForm.spentDate.$invalid && insightForm.$submitted}">

                    <!--Hidden input of the insight chosen date-->
                    <input type="hidden" name="spentDate" ng-model="insightData.spentDate" required valid-date />

                    <!--insight date picker-->
                    <div class="insight__form__date__input">
                        <button type="button"
                                class="insight__form__date__input__btn"
                                ng-click="openDatePicker($event)"
                                ng-model="insightData.spentDate"
                                datepicker-popup
                                is-open="datePickerOpened"
                                ng-change="onChange()"
                                ng-disabled="isLoading"
                                min-date="datePickerMinDate"
                                max-date="datePickerMaxDate"
                                datepicker-mode="'month'" min-mode="month"
                                show-button-bar="false"
                                datepicker-options="{minMode: 'month',datepickerMode: 'month'}">{{isLoading ? 'Loading'
                            : (insightData.spentDate | friendlyMonthDate)}}
                        </button>
                    </div>

                    <!--Error messages-->
                    <div class="form-group-input__message" ng-class="{'has-error': insightForm.spentDate.$invalid && insightForm.$submitted}" ng-messages="insightForm.$error" ng-if="insightForm.$submitted">
                        <div ng-message="required">Please add a date.</div>
                        <div ng-message="validDate">Date should be in the past.</div>
                    </div>
                </div>

                <!-- Select next month -->
                <button type="button" class="insights__controls__form__arrow icon-chevron-right" ng-disabled="isLoading || ! canLoadNextMonth()" ng-click="nextMonth()"></button>

            </form>

            <div class="insights__controls__chart-toggle">
                <a ng-class="{'insights__chart--active': activeChart === INSIGHTS_CHARTS.BAR}" href="javascript:void(0)" ng-click="setActiveChart(INSIGHTS_CHARTS.BAR)">Bar</a>
                <a ng-class="{'insights__chart--active': activeChart === INSIGHTS_CHARTS.DOUGHNUT}" href="javascript:void(0)" ng-click="setActiveChart(INSIGHTS_CHARTS.DOUGHNUT)">Pie</a>
            </div>

        </div>

        <!--Empty state if no expenses for current month-->
        <div class="insights__empty-state" ng-if="insight.model.numberOfTransactions === 0">
            <div class="insights__empty-state__icon"></div>
            <h1>No expenses on this month yet.</h1>

            <div>You'll get some insights here.</div>
        </div>

        <div ng-show="insight.model.numberOfTransactions !== 0">
            <div class="insights__summary">
                Hey, <span>{{currentUser.model.firstName}}</span>! In
                <span>{{(insightData.spentDate | friendlyMonthDate)}}</span>
                you've spent a total of
                <span>{{insight.model.totalAmountSpent | currency:user.model.currency.symbol:user.model.currency.fractionSize}}</span>.
            </div>

            <div ng-if="activeChart === INSIGHTS_CHARTS.BAR" class="insights__chart__bar">
                <canvas id="bar"
                        class="chart chart-bar"
                        data="insightLineData"
                        series="insightLineSeries"
                        legend="false"
                        options="defaultChartOptions"
                        labels="insight.model.insightLabels">
                </canvas>
            </div>

            <div ng-if="activeChart === INSIGHTS_CHARTS.DOUGHNUT" class="insights__chart__doughnut">
                <canvas class="chart chart-doughnut"
                        data="insight.model.insightData"
                        labels="insight.model.insightLabels"
                        legend="true"
                        options="donutChartOptions"
                        colours="insight.model.insightColors">
                </canvas>
            </div>

            <div class="insights__summary">
                <div>
                    You've spent the most on <span class="label-uppercase">{{insight.model.highestAmountCategory.name}}</span>.
                </div>
                <div>
                You had <span>{{insight.model.numberOfTransactions}} transactions</span>, in <span>{{insight.model.totalPerCategoryInsightDTOs.length}} categories</span>.
                Your biggest transaction was <span>{{insight.model.biggestExpense.value | currency:user.model.currency.symbol:user.model.currency.fractionSize}}</span>, on <span class="label-uppercase">{{insight.model.biggestExpense.category.name}}</span>.
                </div>

                <div>
                The category with the most transactions is <span class="label-uppercase">{{insight.model.categoryWithTheMostTransactionsInsightsDTO.categoryDTO.name}}</span>, with <span>{{insight.model.categoryWithTheMostTransactionsInsightsDTO.numberOfTransactions}}</span> transactions.

                </div>
            </div>

            <div class="insights__table">
                <table>
                    <thead class="insights__table__header">
                    <tr>
                        <td>TOTAL</td>
                        <td class="insights__table__amount">{{insight.model.totalAmountSpent | currency:user.model.currency.symbol:user.model.currency.fractionSize}}</td>
                    </tr>
                    </thead>
                    <tbody>
                    <tr ng-repeat="totalPerCategory in insight.model.totalPerCategoryInsightDTOs">
                        <td class="insights__table__category label-uppercase">
                            <span class="insights__table__category__color" ng-style="{'background':totalPerCategory.categoryDTO.color.color}">C</span>
                            {{totalPerCategory.categoryDTO.name}}
                        </td>
                        <td class="insights__table__amount">{{totalPerCategory.totalAmount | currency:user.model.currency.symbol:user.model.currency.fractionSize}}
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>

    </div>

</div>

<div footer class="view-container__footer"></div>
